name: Build NBS
description: Build NBS
on:
  inputs:
    CCACHE_PASSWORD:
      type: string
      required: false
      description: 'CCache htpasswd webdav PUT password'
    REMOTE_CACHE_URL:
      type: string
      required: true
    DISTCC_HOSTS:
      type: string
      required: true
      default: 'localhost/32 dp7329odurnhplpf5ff0.auto.internal/64'

runs:

  steps:
    - name: Configure
      shell: bash
      run: |
        export CONAN_USER_HOME=`realpath ..`
        export DISTCC_HOSTS="${DISTCC_HOSTS}"
        export DISTCC_FALLBACK=0
        export DISTCC_VERBOSE=0
        export HOME=/tmp
        export CCACHE_BASEDIR=`realpath ..`
        export CCACHE_SLOPPINESS=locale
        export CCACHE_REMOTE_STORAGE="${CCACHE_REMOTE_STORAGE}"

        ip addr

        distcc --show-hosts

        cmake -G Ninja -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_TOOLCHAIN_FILE=clang.toolchain \
          -DCMAKE_C_COMPILER_LAUNCHER="ccache;distcc" \
          -DCMAKE_CXX_COMPILER_LAUNCHER="ccache;distcc" \
          .

        ninja ./cloud/blockstore/apps/client/blockstore-client
        df -h
        ccache -s
      env:
        CCACHE_REMOTE_STORAGE: ${{ inputs.REMOTE_CACHE_URL && format('http://{0}{1}', inputs.CCACHE_PASSWORD, inputs.REMOTE_CACHE_URL) || ''}}
        DISTCC_HOSTS: ${{ inputs.DISTCC_HOSTS }}

    - name: report Build failed
      if: ${{ failure() }}
      shell: bash
      run: |
        echo "# Build failed" >> $GITHUB_STEP_SUMMARY
    - name: report Build cancelled
      if: ${{ cancelled() }}
      shell: bash
      run: |
        echo "# Build cancelled" >> $GITHUB_STEP_SUMMARY
