name: Build NBS
description: Build NBS
runs:
  using: "composite"
  steps:
    - name: Configure
      shell: bash
      run: |
        export CONAN_USER_HOME=`realpath ..`
        export DISTCC_HOSTS="${DISTCC_HOSTS}"
        export DISTCC_FALLBACK=0
        export DISTCC_VERBOSE=0
        export HOME=/tmp
        export CCACHE_BASEDIR=`realpath ..`
        export CCACHE_SLOPPINESS=locale
        export CCACHE_DIR=/mnt/ccache
        export CCACHE_MAXSIZE=50G

        ip addr

        distcc --show-hosts

        echo ::group::configure
        cmake -G Ninja -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_TOOLCHAIN_FILE=clang.toolchain \
          -DCMAKE_C_COMPILER_LAUNCHER="ccache" \
          -DCMAKE_CXX_COMPILER_LAUNCHER="ccache" \
          .
        echo ::endgroup::

        echo ::group::build blockstore-client
        ninja ./cloud/blockstore/apps/client/blockstore-client
        echo ::endgroup::

        echo ::group::build nbsd
        ninja ./cloud/blockstore/apps/server/nbsd
        echo ::endgroup::

        echo ::group::build blockstore-nbd
        ninja ./cloud/blockstore/tools/nbd/blockstore-nbd
        echo ::endgroup::

        echo ::group::build diskagentd
        ninja ./cloud/blockstore/apps/disk_agent/diskagentd
        echo ::endgroup::

        echo ::group::build all executable targets
        ninja
        echo ::endgroup::

        df -h
        ccache -sx
    - name: Launch tests
      shell: bash
      run: |
        export CONAN_USER_HOME=`realpath ..`
        ctest

    - name: Report build failed
      if: ${{ failure() }}
      shell: bash
      run: |
        echo "# Build failed" >> $GITHUB_STEP_SUMMARY
    - name: Report build cancelled
      if: ${{ cancelled() }}
      shell: bash
      run: |
        echo "# Build cancelled" >> $GITHUB_STEP_SUMMARY
