name: Build NBS
description: Build NBS
on:
  inputs:
    CCACHE_PASSWORD:
      type: string
      required: false
      description: 'CCache htpasswd webdav PUT password'
    REMOTE_CACHE_URL:
      type: string
      required: true

runs:
  using: "composite"
  steps:
    - name: Build
      shell: bash
      run: |
        export CONAN_USER_HOME=`realpath ..`
        export DISTCC_HOSTS="localhost/32 dp7329odurnhplpf5ff0.auto.internal/32"
        export DISTCC_FALLBACK=0
        export DISTCC_VERBOSE=1
        export HOME=/tmp

        ip addr

        distcc --show-hosts

        cmake -G Ninja -DCMAKE_BUILD_TYPE=Release \
          -DCCACHE_PATH=/usr/local/bin/ccache \
          -DCMAKE_TOOLCHAIN_FILE=clang.toolchain \
          -DCCACHE_BASEDIR=`realpath ..` \
          -DCCACHE_SLOPPINESS=locale \
          -DCMAKE_C_COMPILER_LAUNCHER="ccache;distcc" \
          -DCMAKE_CXX_COMPILER_LAUNCHER="ccache;distcc" \
          -DCCACHE_REMOTE_STORAGE="${CCACHE_REMOTE_STORAGE}" \
          .

        ninja ./cloud/blockstore/apps/client/blockstore-client
        df -h
      env:
        CCACHE_REMOTE_STORAGE: ${{ inputs.REMOTE_CACHE_URL && format('http://{0}{1}', inputs.CCACHE_PASSWORD, inputs.REMOTE_CACHE_URL) || ''}}

    - name: report Build failed
      if: ${{ failure() }}
      shell: bash
      run: |
        echo "# Build failed" >> $GITHUB_STEP_SUMMARY
    - name: report Build cancelled
      if: ${{ cancelled() }}
      shell: bash
      run: |
        echo "# Build cancelled" >> $GITHUB_STEP_SUMMARY
